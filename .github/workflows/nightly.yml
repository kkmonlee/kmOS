name: Nightly Validation

on:
  schedule:
    - cron: '0 3 * * *'
  workflow_dispatch:

env:
  CROSS_TARGET: i686-elf

jobs:
  nightly-tests:
    name: Nightly Build & Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Cache cross-compiler toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: |
          /opt/cross
          ~/.local/cross
        key: ${{ runner.os }}-cross-compiler-${{ env.CROSS_TARGET }}-v2

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bison flex libgmp3-dev libmpc-dev libmpfr-dev texinfo nasm binutils qemu-system-x86 grub-pc-bin xorriso mtools expect

    - name: Build cross-compiler toolchain (if needed)
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        export PREFIX="$HOME/.local/cross"
        export TARGET=$CROSS_TARGET
        export PATH="$PREFIX/bin:$PATH"
        mkdir -p $PREFIX

        cd /tmp
        wget https://ftp.gnu.org/gnu/binutils/binutils-2.40.tar.gz
        tar -xf binutils-2.40.tar.gz
        mkdir binutils-build && cd binutils-build
        ../binutils-2.40/configure --target=$TARGET --prefix="$PREFIX" --with-sysroot --disable-nls --disable-werror
        make -j$(nproc)
        make install

        cd /tmp
        wget https://ftp.gnu.org/gnu/gcc/gcc-12.2.0/gcc-12.2.0.tar.gz
        tar -xf gcc-12.2.0.tar.gz
        mkdir gcc-build && cd gcc-build
        ../gcc-12.2.0/configure --target=$TARGET --prefix="$PREFIX" --disable-nls --enable-languages=c,c++ --without-headers
        make all-gcc -j$(nproc)
        make all-target-libgcc -j$(nproc)
        make install-gcc
        make install-target-libgcc

    - name: Configure toolchain path
      run: |
        echo "$HOME/.local/cross/bin" >> $GITHUB_PATH
        export PATH="$HOME/.local/cross/bin:$PATH"
        i686-elf-gcc --version

    - name: Build kernel
      run: |
        export PATH="$HOME/.local/cross/bin:$PATH"
        make clean
        make all

    - name: Run kernel functionality tests
      run: |
        chmod +x integration_tests/test_kernel_functionality.sh
        ./integration_tests/test_kernel_functionality.sh src/sdk/bootdisk/kernel.elf

    - name: Run QEMU integration tests
      env:
        QEMU_TIMEOUT: 45
      run: |
        chmod +x integration_tests/qemu_integration_test.sh
        ./integration_tests/qemu_integration_test.sh src/sdk/bootdisk/kernel.elf

    - name: Upload nightly artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: nightly-results-${{ github.sha }}
        path: |
          integration_tests/results/
          src/sdk/bootdisk/kernel.elf
        retention-days: 14